# 知識庫文本輸入指南

## 📝 文本資料輸入方式

有三種方式可以輸入文本資料，用於限制聊天機器人的回答範圍：

---

## 方式一：透過網頁介面上傳（推薦）

### 步驟：
1. 開啟瀏覽器前往：http://localhost:5173
2. 點擊「顯示文本上傳介面」按鈕
3. 選擇以下任一方式：

   **選項 A：上傳檔案**
   - 點擊「選擇檔案」
   - 選擇 `.txt` 文字檔案
   - 系統會自動上傳並處理

   **選項 B：直接輸入文本**
   - 在文字框中貼上或輸入您的文本內容
   - 點擊「上傳文本」按鈕

### 優點：
- ✅ 即時生效，無需重啟服務
- ✅ 操作簡單，透過網頁介面即可完成
- ✅ 可隨時更新內容

---

## 方式二：直接編輯檔案（適合大量文字）

### 檔案位置：
```
backend/data/knowledge_base.txt
```

### 步驟：
1. 使用文字編輯器開啟 `backend/data/knowledge_base.txt`
2. 貼上或輸入您的文本內容
3. 儲存檔案
4. **重啟後端服務**（重要！）

### 重啟後端服務：
```bash
# 停止現有服務（在運行後端的終端機按 Ctrl+C）
# 然後重新啟動
cd backend
npm run dev
```

### 優點：
- ✅ 適合大量文字內容
- ✅ 可以使用專業編輯器
- ✅ 方便版本控制

---

## 方式三：透過 API 上傳（適合程式化操作）

### 上傳文字檔案：
```bash
curl -X POST http://localhost:3001/api/upload/file \
  -F "file=@your_file.txt"
```

### 直接上傳文字內容：
```bash
curl -X POST http://localhost:3001/api/upload/text \
  -H "Content-Type: text/plain" \
  -d "您的文本內容..."
```

---

## 📋 文本格式要求

### 基本格式：
- **純文字格式**：`.txt` 檔案或純文字內容
- **編碼**：建議使用 UTF-8 編碼（支援中文）
- **檔案大小**：最大 10MB

### 內容格式建議：

#### ✅ 推薦格式（結構化）：
```
歡迎使用我們的客服系統。

常見問題：

1. 退貨政策
   - 商品收到後 7 天內可申請退貨
   - 商品需保持原狀，未使用過
   - 運費由買家負擔
   - 退款將在收到商品後 3-5 個工作天內處理

2. 運送時間
   - 台灣本島：3-5 個工作天
   - 離島地區：5-7 個工作天
   - 海外地區：7-14 個工作天
   - 超商取貨：2-3 個工作天

3. 付款方式
   - 信用卡（Visa、MasterCard、JCB）
   - ATM 轉帳
   - 超商代碼繳費
   - 貨到付款（需加收手續費 NT$ 30）

4. 聯絡資訊
   - 客服電話：0800-123-456
   - 服務時間：週一至週五 9:00-18:00
   - 電子郵件：service@example.com
   - 線上客服：24 小時服務
```

#### ✅ 也可以使用段落格式：
```
產品介紹

我們的產品採用最新技術，具有以下特點：
1. 高效能處理
2. 節能環保
3. 易於使用

價格資訊：
基本版：NT$ 1,000
專業版：NT$ 2,500
企業版：請聯繫業務

使用說明：
請按照以下步驟操作：
步驟一：開啟電源
步驟二：選擇模式
步驟三：開始使用
```

### 格式注意事項：
- ✅ 使用段落分隔（空行）有助於系統理解結構
- ✅ 使用標題、編號、列表讓內容更清晰
- ✅ 重要資訊可以用明確的標題標示
- ✅ 支援中文、英文等多種語言
- ✅ **建議包含客服電話和電子郵件**，以便系統在無相關資料時提供聯繫方式

---

## 🔍 文本處理機制

### 自動分塊：
- 系統會自動將文本分割成較小的區塊（預設約 1000 字元/區塊）
- 區塊之間會有適當的重疊（200 字元），確保上下文連貫
- 系統會根據段落和句子進行智能分割

### 檢索機制：
當使用者提問時，系統會執行以下流程：

1. **AI 語義擴展**：
   - 使用 Gemini AI 理解問題的語義
   - 擴展同義詞和相關關鍵字
   - 例如：「營業時間」→「營業時間 服務時間 開店時間 營業時段」

2. **文本檢索**：
   - 使用擴展後的查詢從知識庫檢索最相關的文本區塊
   - 返回前 5 個最相關的區塊

3. **回答生成**：
   - **精準模式**：使用檢索到的相關區塊生成回答
   - **完整模式**：如果精準搜索失敗，使用整個知識庫讓 AI 理解並重組答案
   - **預設模式**：如果知識庫無相關資料，AI 生成自然、多樣化的友善答覆

### 回答限制：
- ✅ **有知識庫內容時**：AI 嚴格基於知識庫內容回答
- ✅ **找不到相關內容時**：AI 生成自然、多樣化的友善答覆（包含客服聯繫方式）
- ✅ **沒有知識庫時**：返回預設訊息

---

## 🤖 自動知識庫擴展功能

### 功能說明

當精準搜索失敗但 AI 成功從完整知識庫找到答案時，系統會自動：

1. **分析問題和答案**：
   - AI 分析使用者問題和生成的答案
   - 找出知識庫中最相關的段落

2. **生成擴展關鍵字**：
   - 根據問題和答案，生成 3-5 個擴展關鍵字或同義詞
   - 例如：問題「營業時間是什麼？」→ 關鍵字「營業時間 開店時間 營業時段 服務時段」

3. **整合到知識庫**：
   - 將擴展關鍵字添加到對應段落的標題或內容中
   - 更新知識庫檔案
   - 重新載入知識庫到記憶體

4. **提升檢索準確度**：
   - 下次客戶問相似問題時，精準搜索就能直接找到答案
   - 不需要再使用完整知識庫模式

### 範例

**第一次詢問：**
- 客戶問：「營業時間是什麼？」
- 精準搜索失敗（知識庫只有「服務時間」）
- 系統使用完整知識庫，AI 找到答案：「服務時間為週一至週五 9:00-18:00」
- **系統自動擴展**：將「營業時間 開店時間 營業時段 服務時段」添加到知識庫

**知識庫更新後：**
```
4. 聯絡資訊 （相關關鍵字：營業時間、開店時間、營業時段、服務時段）
   - 客服電話：0800-123-456
   - 服務時間：週一至週五 9:00-18:00
   ...
```

**第二次詢問：**
- 客戶問：「開店時間是幾點？」
- 精準搜索成功！直接找到答案，不需要使用完整知識庫

### 注意事項

- ✅ **非阻塞執行**：擴展過程在背景執行，不影響回應速度
- ✅ **自動化**：無需手動維護，系統自動學習
- ✅ **容錯處理**：擴展失敗不影響正常回答
- ⚠️ **需要知識庫有相關內容**：只有在知識庫有相關資料時才會擴展
- ⚠️ **需要成功生成回答**：只有在 AI 成功生成回答時才會擴展

---

## 📝 範例文本

### 範例 1：客服常見問題
```
歡迎使用客服系統

常見問題：

Q: 如何申請退貨？
A: 請在收到商品後 7 天內，登入會員中心申請退貨。

Q: 運費如何計算？
A: 台灣本島運費 NT$ 100，離島地區 NT$ 150。

Q: 商品何時出貨？
A: 下單後 1-2 個工作天內出貨。

聯絡資訊：
客服電話：0800-123-456
服務時間：週一至週五 9:00-18:00
電子郵件：service@example.com
```

### 範例 2：產品說明
```
產品規格

型號：ABC-123
尺寸：30cm x 20cm x 10cm
重量：1.5kg
顏色：黑色、白色、銀色

功能特色：
- 高效能處理器
- 長效電池（續航 8 小時）
- 防水設計（IP67）
- 觸控螢幕

保固資訊：
- 保固期：1 年
- 保固範圍：非人為損壞
- 保固服務：免費維修或換貨
```

### 範例 3：服務條款
```
服務條款

1. 使用規範
   使用者應遵守相關法律法規，不得用於非法用途。

2. 隱私保護
   我們重視您的隱私，不會洩露您的個人資訊。

3. 服務變更
   我們保留隨時修改服務內容的權利。
```

---

## ⚠️ 注意事項

1. **文字編碼**：確保檔案使用 UTF-8 編碼，避免中文亂碼
2. **檔案大小**：建議單個檔案不超過 10MB
3. **內容更新**：透過網頁上傳會立即生效，編輯檔案需要重啟服務
4. **內容品質**：內容越清晰、結構化，AI 回答越準確
5. **關鍵字**：在文本中使用明確的關鍵字，有助於檢索
6. **客服資訊**：建議包含客服電話和電子郵件，以便系統在無相關資料時提供聯繫方式
7. **自動擴展**：系統會自動學習並擴展關鍵字，無需手動維護

---

## 🧪 測試建議

上傳文本後，建議測試以下類型的問題：
- ✅ 直接詢問文本中的內容（應該能準確回答）
- ✅ 使用不同的問法詢問相同內容（測試語義理解和自動擴展）
- ✅ 詢問文本中沒有的內容（應該生成自然、多樣化的友善答覆）
- ✅ 測試同義詞匹配（例如：「營業時間」和「服務時間」）

---

## 📞 需要幫助？

如果遇到問題：
1. 檢查文本格式是否正確
2. 確認檔案編碼為 UTF-8
3. 查看後端終端機的日誌訊息
4. 檢查系統狀態頁面（顯示知識庫載入狀態）
