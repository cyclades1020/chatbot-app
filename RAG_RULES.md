# RAG 回答規則文件

## 規則格式說明

請使用以下格式描述您的 RAG 回答規則：

```
## 規則編號：規則名稱

**觸發條件：**
- 條件 1
- 條件 2

**執行邏輯：**
1. 步驟 1
2. 步驟 2

**回應內容：**
- 情況 A：回應內容 A
- 情況 B：回應內容 B

**例外處理：**
- 例外情況：處理方式
```

---

## 已實作的規則

### 規則 1：智能兩階段檢索系統

**觸發條件：**
- 知識庫有內容
- 使用者提出問題

**執行邏輯：**
1. **第一階段：AI 語義擴展**
   - 使用 Gemini AI 理解問題的語義
   - 擴展同義詞和相關關鍵字
   - 例如：「營業時間」→「營業時間 服務時間 開店時間 營業時段」

2. **第二階段：文本檢索**
   - 使用擴展後的查詢從知識庫檢索相關文本區塊
   - 返回前 5 個最相關的文本區塊

3. **第三階段：回答生成**
   - **精準模式**：如果找到相關區塊，使用檢索結果生成回答（節省 token）
   - **完整模式**：如果精準搜索失敗，使用整個知識庫讓 AI 理解並重組答案
   - **預設模式**：如果知識庫無相關資料，AI 生成自然、多樣化的友善答覆

**回應內容：**
- 找到相關內容（精準模式）：基於知識庫內容回答
- 找到相關內容（完整模式）：AI 理解並重組知識庫內容回答
- 找不到相關內容：AI 生成自然、多樣化的友善答覆（包含客服聯繫方式）

**例外處理：**
- 如果知識庫為空：回應「不好意思，您的問題我們需要一些時間確認後再回覆您，請您稍等。如有緊急問題，請聯繫客服。」

---

### 規則 2：自動知識庫擴展

**觸發條件：**
- 精準搜索失敗（`relevantChunks.length === 0`）
- 使用完整知識庫模式（`useFullKnowledgeBase = true`）
- AI 成功生成回答

**執行邏輯：**
1. **非同步分析**（背景執行，不阻塞回應）
   - AI 分析使用者問題和生成的答案
   - 找出知識庫中最相關的段落
   - 生成 3-5 個擴展關鍵字或同義詞

2. **整合到知識庫**
   - 在知識庫中找到匹配的段落
   - 將擴展關鍵字添加到段落標題或內容中
   - 更新知識庫檔案
   - 重新載入知識庫到記憶體

3. **提升檢索準確度**
   - 下次客戶問相似問題時，精準搜索就能直接找到答案

**回應內容：**
- 擴展成功：知識庫自動更新，未來檢索更準確
- 擴展失敗：不影響正常回答，系統繼續運作

**例外處理：**
- 如果無法分析出相關段落或關鍵字：跳過擴展，不影響回答
- 如果擴展過程發生錯誤：記錄錯誤但不拋出，確保回答正常返回

---

### 規則 3：自然多樣化答覆生成

**觸發條件：**
- 知識庫中完全沒有相關資訊
- AI 檢測到無法從知識庫重組出答案

**執行邏輯：**
1. **AI 標記檢測**
   - AI 返回 `NO_RELEVANT_INFO` 標記
   - 系統檢測標記並提取 AI 生成的訊息

2. **訊息處理**
   - 完全移除 `NO_RELEVANT_INFO` 標記（不顯示給用戶）
   - 檢查訊息是否符合要求（包含確認、聯繫等關鍵字）

3. **自然答覆生成**
   - 如果 AI 生成的訊息不符合要求，再次調用 AI 生成自然答覆
   - 從知識庫自動提取客服電話和電子郵件
   - 生成自然、多樣化的表達方式

**回應內容：**
- 自然、多樣化的友善答覆
- 表達歉意並說明需要時間確認
- 提供客服聯繫方式（電話和/或 email）
- 每次回答措辭不同，但保持相同含義和專業度

**範例答覆：**
- 「很抱歉，關於這個問題我們需要進一步確認，請您稍候。若您有緊急需求，歡迎致電 0800-123-456 或發送郵件至 service@example.com，我們會盡快為您處理。」
- 「感謝您的詢問，這個問題我們需要一些時間查詢相關資訊。如有緊急情況，請聯繫客服電話 0800-123-456 或 email service@example.com，我們會優先處理您的需求。」

**例外處理：**
- 如果知識庫中沒有客服資訊：使用通用訊息「如有緊急問題，請聯繫客服」

---

### 規則 4：嚴格知識庫回答限制

**觸發條件：**
- 知識庫有內容
- 找到相關內容或使用完整知識庫模式

**執行邏輯：**
1. **嚴格限制提示詞**
   - 明確要求只能根據提供的文本內容回答
   - 絕對不能編造或推測文本中沒有的資訊

2. **允許重組**
   - 可以將知識庫中的不同段落資訊重組
   - 形成完整的回答
   - 但必須完全基於提供的文本內容

3. **語義理解**
   - 理解問題的語義，即使用詞不完全相同
   - 例如：「營業時間」=「服務時間」，「退貨政策」=「退貨規定」

**回應內容：**
- 基於知識庫內容的準確回答
- 可以重組不同段落的資訊
- 回答簡潔、友善且專業（不超過 3 句話）

**例外處理：**
- 如果找不到相關內容：執行規則 3（自然多樣化答覆生成）

---

### 規則 5：串流模式與降級機制

**觸發條件：**
- 前端請求串流模式（`stream: true`）
- 或前端自動啟用串流模式

**執行邏輯：**
1. **串流模式**
   - 使用 Server-Sent Events (SSE) 即時回應
   - AI 回答逐字顯示，提升使用者體驗

2. **自動降級**
   - 如果串流模式失敗，自動切換到一般模式
   - 確保服務不中斷

**回應內容：**
- 串流模式：逐字顯示 AI 回答
- 降級模式：一次性顯示完整回答

**例外處理：**
- 串流失敗時自動降級，不影響使用者體驗

---

## 工作流程總覽

```
使用者提問
    ↓
規則 1：智能兩階段檢索
    ├─ AI 語義擴展
    ├─ 文本檢索
    └─ 回答生成
        ├─ 精準模式（找到相關區塊）
        ├─ 完整模式（精準搜索失敗）
        │   └─ 規則 2：自動知識庫擴展（背景執行）
        └─ 預設模式（知識庫無相關資料）
            └─ 規則 3：自然多樣化答覆生成
    ↓
規則 4：嚴格知識庫回答限制
    └─ 確保回答基於知識庫內容
    ↓
規則 5：串流模式與降級機制
    └─ 提供即時回應體驗
```

---

## 如何填寫新規則

請按照以下格式填寫您的規則：

```markdown
### 規則 X：規則名稱

**觸發條件：**
- [描述什麼情況下觸發這個規則]

**執行邏輯：**
1. [第一步要做什麼]
2. [第二步要做什麼]
3. [第三步要做什麼]

**回應內容：**
- 情況 A：[回應內容 A]
- 情況 B：[回應內容 B]

**例外處理：**
- 例外情況：[處理方式]

**其他說明：**
- [任何其他需要注意的事項]
```

填寫完成後，告知開發團隊「請更新規則」，開發團隊會根據規則自動更新程式碼。

---

## 規則修改歷史

- **2024-12**：新增規則 1（智能兩階段檢索系統）
- **2024-12**：新增規則 2（自動知識庫擴展）
- **2024-12**：新增規則 3（自然多樣化答覆生成）
- **2024-12**：新增規則 4（嚴格知識庫回答限制）
- **2024-12**：新增規則 5（串流模式與降級機制）
